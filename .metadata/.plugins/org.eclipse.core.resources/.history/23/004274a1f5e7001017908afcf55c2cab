package com.yourorg.telemedicine.alert.service;

import com.yourorg.telemedicine.alert.client.PatientClient;
import com.yourorg.telemedicine.alert.client.WearableClient;
import com.yourorg.telemedicine.alert.dto.VitalData;
import com.yourorg.telemedicine.alert.entity.Alert;
import com.yourorg.telemedicine.alert.kafka.AlertProducer;
import com.yourorg.telemedicine.alert.ml.VitalTrendAnalyzer;
import com.yourorg.telemedicine.alert.repo.AlertRepository;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class AlertServiceImpl implements AlertService {

    @Autowired
    private WearableClient wearableClient;

    @Autowired
    private PatientClient patientClient;

    @Autowired
    private AlertProducer alertProducer;

    @Autowired
    private VitalTrendAnalyzer trendAnalyzer;
    @Autowired
    private AlertRepository alertRepository;


    @Override
    public String checkVitalsAndNotify(Long patientId) {

        // 1Ô∏è‚É£ Fetch recent vitals
        List<VitalData> vitalsList =
                wearableClient.getRecentVitals(patientId);

        if (vitalsList == null || vitalsList.isEmpty()) {
            return "No vitals found. Alert not sent.";
        }
  
  


        // 2Ô∏è‚É£ ML / Rule-based analysis
        boolean risk = trendAnalyzer.isHealthRisk(vitalsList);
        boolean criticalRisk = trendAnalyzer.isCriticalRisk(vitalsList);
        
        // 3Ô∏è‚É£ Prepare alert details
        String severity = criticalRisk ? "CRITICAL" : "RISK";


        if (!risk) {
            return "Vitals stable (ML analysis)";
        }

        // 3Ô∏è‚É£ Notify PATIENT only
        String patientMessage =
                criticalRisk
                        ? "üö® CRITICAL ALERT: Abnormal vitals detected. Please seek medical help immediately."
                        : "‚ö†Ô∏è Health alert: Unusual vitals detected. Monitor closely.";

        patientClient.notifyPatient(patientId, patientMessage);
        Alert alert = new Alert(patientId, message, severity);
        alertRepository.save(alert);


        // 4Ô∏è‚É£ Publish alert to Kafka (optional, for logs / analytics)
        alertProducer.sendAlert(
                "Alert sent to patient " + patientId + " | Critical=" + criticalRisk
        );

        return "Alert sent to patient";
    }
}
