package com.yourorg.telemedicine.ai.util;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.stereotype.Component;

import com.yourorg.telemedicine.ai.entity.ChatMessage;
import com.yourorg.telemedicine.ai.entity.VitalReading;

@Component
public class PromptBuilder {

    public String buildPrompt(
            VitalReading vitals,
            List<ChatMessage> history,
            String userMessage) {

        String historyText = history.stream()
                .limit(6) // avoid long context
                .map(m -> m.getRole() + ": " + m.getMessage())
                .collect(Collectors.joining("\n"));

        String vitalsText = (vitals == null)
                ? "No recent vitals available."
                : """
                  ‚Ä¢ Heart Rate: %d bpm
                  ‚Ä¢ SpO‚ÇÇ: %d %%
                  ‚Ä¢ Blood Pressure: %d / %d mmHg
                  """.formatted(
                        vitals.getHeartRate(),
                        vitals.getSpo2(),
                        vitals.getSystolicBP(),
                        vitals.getDiastolicBP()
                );

        return """
        You are MediFusion AI, a healthcare assistant.

        STRICT RULES:
        - Be concise and clear
        - Use bullet points only
        - Do NOT repeat the same sentence
        - Do NOT diagnose diseases
        - Classify vitals as Normal / Low / High
        - Give clear next steps
        - Add ONE disclaimer line only

        RESPONSE FORMAT (follow exactly):
        ü©∫ Health Summary (1‚Äì2 lines)

        üìä Vitals:
        (classified values)

        üö® Status:
        (Normal / Warning / Critical)

        ‚úÖ Recommended Actions:
        (max 3 bullets)

        ‚ÑπÔ∏è Disclaimer:
        (single line)

        Patient Vitals:
        %s

        Recent Conversation:
        %s

        User Question:
        %s
        """.formatted(
                vitalsText,
                historyText,
                userMessage
        );
    }
}
