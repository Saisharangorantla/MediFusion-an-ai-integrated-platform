version: "3.8"

services:
  # Infrastructure Services
  mysql:
    image: mysql:8.0
    container_name: telemedicine-mysql
    environment:
      MYSQL_ROOT_PASSWORD: Saisharan@2006
      MYSQL_DATABASE: MediFusion_db
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - telemedicine-network

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: telemedicine-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - telemedicine-network

  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: telemedicine-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - telemedicine-network

  # Configuration Server (should start early)
  cloud-config:
    build: ./cloud-config
    container_name: telemedicine-cloud-config
    ports:
      - "9500:9500"
    environment:
      SPRING_CLOUD_CONFIG_SERVER_GIT_URI: https://github.com/Saisharangorantla/Telemedicine_config.git
    networks:
      - telemedicine-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9500/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Service Discovery (should start early)
  eureka-service:
    build: ./eureka-service
    container_name: telemedicine-eureka
    ports:
      - "8761:8761"
    environment:
      SPRING_APPLICATION_NAME: eureka-service
      SERVER_PORT: 8761
      EUREKA_CLIENT_REGISTER_WITH_EUREKA: "false"
      EUREKA_CLIENT_FETCH_REGISTRY: "false"
      SPRING_CONFIG_IMPORT: "optional:configserver:http://cloud-config:9500"
    depends_on:
      - cloud-config
    networks:
      - telemedicine-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # API Gateway
  api-gateway:
    build: ./api-gate-way
    container_name: telemedicine-api-gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_APPLICATION_NAME: api-gate-way
      SERVER_PORT: 8080
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-service:8761/eureka
      SPRING_CONFIG_IMPORT: "optional:configserver:http://cloud-config:9500"
      JWT_SECRET: secretkey
    depends_on:
      - eureka-service
      - cloud-config
    networks:
      - telemedicine-network

  # Auth Service
  auth-service:
    build: ./Auth-service
    container_name: telemedicine-auth-service
    ports:
      - "8075:8075"
    environment:
      SPRING_APPLICATION_NAME: auth-service
      SERVER_PORT: 8075
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-service:8761/eureka
      SPRING_CONFIG_IMPORT: "optional:configserver:http://cloud-config:9500"
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/MediFusion_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Saisharan@2006
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: com.mysql.cj.jdbc.Driver
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.MySQLDialect
      JWT_SECRET: secretkey
      SPRING_MAIN_ALLOW_CIRCULAR_REFERENCES: "true"
    depends_on:
      mysql:
        condition: service_healthy
      eureka-service:
        condition: service_healthy
      cloud-config:
        condition: service_healthy
    networks:
      - telemedicine-network

  # Patient Service
  patient-service:
    build: ./patient-service
    container_name: telemedicine-patient-service
    ports:
      - "8083:8083"
    environment:
      SPRING_APPLICATION_NAME: patient-service
      SERVER_PORT: 8083
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-service:8761/eureka
      SPRING_CONFIG_IMPORT: "optional:configserver:http://cloud-config:9500"
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/MediFusion_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Saisharan@2006
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: com.mysql.cj.jdbc.Driver
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.MySQLDialect
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_KAFKA_PRODUCER_KEY_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
      SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
      TWILIO_ACCOUNT_SID: YOUR_TWILIO_ACCOUNT_SID
      TWILIO_AUTH_TOKEN: YOUR_TWILIO_AUTH_TOKEN
      TWILIO_FROM_NUMBER: +1234567890
    depends_on:
      mysql:
        condition: service_healthy
      kafka:
        condition: service_started
      eureka-service:
        condition: service_healthy
      cloud-config:
        condition: service_healthy
    networks:
      - telemedicine-network

  # Doctor Service
  doctor-service:
    build: ./doctor-service
    container_name: telemedicine-doctor-service
    ports:
      - "8085:8085"
    environment:
      SPRING_APPLICATION_NAME: doctor-service
      SERVER_PORT: 8085
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-service:8761/eureka
      SPRING_CONFIG_IMPORT: "optional:configserver:http://cloud-config:9500"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_KAFKA_PRODUCER_KEY_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
      SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
      TWILIO_ACCOUNT_SID: YOUR_TWILIO_ACCOUNT_SID
      TWILIO_AUTH_TOKEN: YOUR_TWILIO_AUTH_TOKEN
      TWILIO_FROM_NUMBER: +1234567890
    depends_on:
      kafka:
        condition: service_started
      eureka-service:
        condition: service_healthy
      cloud-config:
        condition: service_healthy
    networks:
      - telemedicine-network

  # Health Record Service
  health-record-service:
    build: ./health-record-service
    container_name: telemedicine-health-record-service
    ports:
      - "8084:8084"
    environment:
      SPRING_APPLICATION_NAME: health-record-service
      SERVER_PORT: 8084
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-service:8761/eureka
      SPRING_CONFIG_IMPORT: "optional:configserver:http://cloud-config:9500"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_KAFKA_PRODUCER_KEY_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
      SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
    depends_on:
      kafka:
        condition: service_started
      eureka-service:
        condition: service_healthy
      cloud-config:
        condition: service_healthy
    networks:
      - telemedicine-network

  # Appointment Service
  appointment-service:
    build: ./appointment-service
    container_name: telemedicine-appointment-service
    ports:
      - "8087:8087"
    environment:
      SPRING_APPLICATION_NAME: appointment-service
      SERVER_PORT: 8087
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-service:8761/eureka
      SPRING_CONFIG_IMPORT: "optional:configserver:http://cloud-config:9500"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_KAFKA_PRODUCER_KEY_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
      SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
    depends_on:
      kafka:
        condition: service_started
      eureka-service:
        condition: service_healthy
      cloud-config:
        condition: service_healthy
    networks:
      - telemedicine-network

  # Wearable Service
  wearable-service:
    build: ./wearable-service
    container_name: telemedicine-wearable-service
    ports:
      - "8081:8081"
    environment:
      SPRING_APPLICATION_NAME: wearable-service
      SERVER_PORT: 8081
      PATIENT_SERVICE_URL: http://patient-service:8083
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-service:8761/eureka
      SPRING_CONFIG_IMPORT: "configserver:http://cloud-config:9500"
      APPLE_CLIENT_ID: your-apple-client-id
      APPLE_CLIENT_SECRET: your-apple-client-secret
      APPLE_REDIRECT_URI: http://localhost:8080/api/wearables/apple/callback
    depends_on:
      patient-service:
        condition: service_started
      eureka-service:
        condition: service_healthy
      cloud-config:
        condition: service_healthy
    networks:
      - telemedicine-network

  # Recommendation Service
  recommendation-service:
    build: ./recommendation-service
    container_name: telemedicine-recommendation-service
    ports:
      - "8070:8070"
    environment:
      SPRING_APPLICATION_NAME: recommendation-service
      SERVER_PORT: 8070
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-service:8761/eureka
      SPRING_CONFIG_IMPORT: "optional:configserver:http://cloud-config:9500"
      DOCTOR_SERVICE_BASE_URL: http://doctor-service:8085
      PATIENT_SERVICE_BASE_URL: http://patient-service:8083
      HEALTH_RECORD_SERVICE_BASE_URL: http://health-record-service:8084
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/MediFusion_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Saisharan@2006
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: com.mysql.cj.jdbc.Driver
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.MySQLDialect
    depends_on:
      mysql:
        condition: service_healthy
      doctor-service:
        condition: service_started
      patient-service:
        condition: service_started
      health-record-service:
        condition: service_started
      eureka-service:
        condition: service_healthy
      cloud-config:
        condition: service_healthy
    networks:
      - telemedicine-network

  # Alert Service
  alert-service:
    build: ./alert-service
    container_name: telemedicine-alert-service
    ports:
      - "8090:8090"
    environment:
      SPRING_APPLICATION_NAME: alert-service
      SERVER_PORT: 8090
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_KAFKA_PRODUCER_KEY_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
      SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
      SPRING_CONFIG_IMPORT: "configserver:http://cloud-config:9500"
    depends_on:
      kafka:
        condition: service_started
      cloud-config:
        condition: service_healthy
    networks:
      - telemedicine-network

  # AI Service
  ai-service:
    build: ./ai-service
    container_name: telemedicine-ai-service
    ports:
      - "8077:8077"
    environment:
      SPRING_APPLICATION_NAME: ai-service-1
      SERVER_PORT: 8077
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_API_URL: https://api.openai.com/v1/chat/completions
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-service:8761/eureka
      SPRING_CONFIG_IMPORT: "configserver:http://cloud-config:9500"
    depends_on:
      eureka-service:
        condition: service_healthy
      cloud-config:
        condition: service_healthy
    networks:
      - telemedicine-network
  # Frontend (served by nginx)
  frontend:
    build: ../frontend
    container_name: telemedicine-frontend
    ports:
      - "3000:80"
    environment:
      - VITE_API_BASE_URL=http://localhost:8080
    depends_on:
      - api-gateway
    networks:
      - telemedicine-network

networks:
  telemedicine-network:
    driver: bridge

volumes:
  mysql_data:
