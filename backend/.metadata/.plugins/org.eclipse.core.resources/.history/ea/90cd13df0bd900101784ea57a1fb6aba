package com.yourorg.telemedicine.ai.service;

import java.util.List;

import org.springframework.stereotype.Service;

import com.yourorg.telemedicine.ai.client.OpenAIClient;
import com.yourorg.telemedicine.ai.client.WearableClient;
import com.yourorg.telemedicine.ai.dto.ChatRequestDto;
import com.yourorg.telemedicine.ai.dto.PatientDTO;
import com.yourorg.telemedicine.ai.dto.VitalReadingDto;
import com.yourorg.telemedicine.ai.entity.AIChatMessageEntity;
import com.yourorg.telemedicine.ai.entity.AIChatSessionEntity;
import com.yourorg.telemedicine.ai.repository.AIChatMessageRepository;
import com.yourorg.telemedicine.ai.repository.AIChatSessionRepository;
import com.yourorg.telemedicine.ai.util.PromptBuilder;

import lombok.RequiredArgsConstructor;
import reactor.core.publisher.Mono;

@Service
@RequiredArgsConstructor
public class AIChatService {


	private final OpenAIClient openAIClient;
	private final AIChatSessionRepository sessionRepo;
	private final AIChatMessageRepository messageRepo;
	private final PromptBuilder promptBuilder;
	private final WearableClient wearableClient;


	public Mono<String> chat(ChatRequestDto dto,PatientDTO dto1) {

        List<VitalReadingDto> vitals =
                wearableClient.getVitals(dto1.getId());

        String vitalsText = vitals.toString();

		AIChatSessionEntity session = dto.getSessionId() == null
						? sessionRepo.save(newSession(dto.getUserId()))
								: sessionRepo.findById(dto.getSessionId()).orElseThrow();


		saveMessage(session, AIChatMessageEntity.Role.USER, dto.getMessage());


		List<AIChatMessageEntity> history =
				messageRepo.findTop10BySessionIdOrderByCreatedAtAsc(session.getId());


		String prompt = promptBuilder.build(history, dto.getMessage());


		return openAIClient.chat(prompt)
				.map(reply -> {
					saveMessage(session, AIChatMessageEntity.Role.AI, reply);
					return reply;
				});
}


	private AIChatSessionEntity newSession(Long userId) {
		AIChatSessionEntity s = new AIChatSessionEntity();
		s.setUserId(userId);
		return s;
	}


	private void saveMessage(AIChatSessionEntity session,
			AIChatMessageEntity.Role role,String msg) {
		AIChatMessageEntity m = new AIChatMessageEntity();
		m.setSession(session);
		m.setRole(role);
		m.setMessage(msg);
		messageRepo.save(m);
	}
}
